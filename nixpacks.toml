# ==============================================================================
# nixpacks.toml - Configurare Railway Build pentru Aplicația Pulsoximetrie
# ==============================================================================
# SCOP: Adaugă Chromium în container pentru Kaleido (export grafice Plotly)
# ==============================================================================

[phases.setup]
# Pachete system necesare pentru aplicația de pulsoximetrie
nixPkgs = [
    'python3',           # Python 3.12 (default Railway)
    'postgresql_16.dev', # PostgreSQL client pentru psycopg2
    'gcc',               # Compiler pentru pachete native Python
    'chromium',          # CRITICAL: Browser pentru Kaleido (export imagini Plotly)
    'nss',               # Network Security Services (necesar pentru Chromium)
    'fontconfig'         # Font configuration (necesar pentru rendering text în grafice)
]

# Pachete APT necesare pentru dependențele de sistem ale Chromium/Kaleido
aptPkgs = [
    'libnss3',
    'libatk-bridge2.0-0t64',
    'libcups2t64',
    'libxcomposite1',
    'libxdamage1',
    'libxfixes3',
    'libxrandr2',
    'libgbm1',
    'libxkbcommon0',
    'libpango-1.0-0',
    'libcairo2',
    'libasound2t64'
]

# Variabile de mediu pentru Chromium (Kaleido auto-detectează)
nixPkgsArchive = "bc8f8d1be58e8c8383e683a06e1e1e57893fff87"

[phases.install]
# Instalare dependințe Python din requirements.txt
cmds = [
    'python -m venv --copies /opt/venv',
    '. /opt/venv/bin/activate && pip install -r requirements.txt'
]

[phases.build]
# Build phase (opțional - pentru compilări custom)
# cmds = []

[start]
# Comandă pornire aplicație (PRODUCTION: Gunicorn WSGI server)
# FIX: --preload forțează workers să împartă același asset registry
# FIX: wsgi:application (NU run_medical:app.server) pentru consistent init
# CACHE_BUST_v3: Force Railway rebuild - Syntax fix
cmd = 'gunicorn --workers 4 --threads 2 --timeout 120 --preload --bind 0.0.0.0:$PORT --log-level warning --access-logfile - --error-logfile - wsgi:application'
