# ==============================================================================
# nixpacks.toml - Configurare Railway Build pentru Aplicația Pulsoximetrie
# ==============================================================================
# SCOP: Adaugă Chromium în container pentru Kaleido (export grafice Plotly)
#
# DOCUMENTAȚIE:
# - Railway folosește Nixpacks pentru build automat
# - Kaleido v1.2.0+ necesită Chrome/Chromium pentru rendering imagini
# - Fără Chromium → RuntimeError la fig.write_image()
#
# REFERINȚE:
# - https://nixpacks.com/docs/configuration/file
# - https://docs.railway.app/reference/nixpacks
# ==============================================================================

[phases.setup]
# Pachete system necesare pentru aplicația de pulsoximetrie
nixPkgs = [
    'python3',           # Python 3.12 (default Railway)
    'postgresql_16.dev', # PostgreSQL client pentru psycopg2
    'gcc',               # Compiler pentru pachete native Python
    'chromium',          # CRITICAL: Browser pentru Kaleido (export imagini Plotly)
    'nss',               # Network Security Services (necesar pentru Chromium)
    'fontconfig'         # Font configuration (necesar pentru rendering text în grafice)
]

# Variabile de mediu pentru Chromium (Kaleido auto-detectează)
nixPkgsArchive = "bc8f8d1be58e8c8383e683a06e1e1e57893fff87"

[phases.install]
# Instalare dependințe Python din requirements.txt
cmds = [
    'python -m venv --copies /opt/venv',
    '. /opt/venv/bin/activate && pip install -r requirements.txt'
]

[phases.build]
# Build phase (opțional - pentru compilări custom)
# cmds = []

[start]
# Comandă pornire aplicație (PRODUCTION: Gunicorn WSGI server)
cmd = 'gunicorn --workers 4 --threads 2 --timeout 120 --bind 0.0.0.0:$PORT --log-level warning --access-logfile - --error-logfile - "run_medical:app.server"'

# ==============================================================================
# TROUBLESHOOTING:
# 
# 1. Dacă Kaleido tot nu găsește Chrome:
#    - Verifică Deploy Logs: "CHROMIUM_PATH=/nix/store/..."
#    - Setează manual: CHROMIUM_PATH în Railway Variables
# 
# 2. Dacă build-ul este lent:
#    - Normal: Chromium adaugă ~200MB la imagine
#    - Prima build: ~3-4 minute
#    - Build-uri următoare: cached (~60-90s)
# 
# 3. Alternative dacă Chromium nu funcționează:
#    - Dezactivează export imagini: R2_BATCH_EXPORT_ENABLED=False
#    - Folosește fallback graceful din batch_processor.py
# ==============================================================================

